"use client";

import { useState, useEffect, useRef, type ReactNode } from "react";

import { HiOutlineUser, HiOutlineLockClosed, HiOutlineBell, HiOutlineEye, HiOutlineEyeSlash, HiOutlineCheckCircle, HiOutlineExclamationCircle, HiOutlineInformationCircle, HiOutlineShieldCheck, HiOutlineXMark, HiOutlineCamera } from "react-icons/hi2";
import { useSession } from "next-auth/react";
import { toast } from "sonner";
import { z } from "zod";
import Sidebar from "@/components/sidebar";

type UserProfile = {
  firstName?: string;
  lastName?: string;
  email: string;
  profilePic?: string;
};

type PrivacySettings = {
  showProfile: boolean;
  searchable: boolean;
};

type NotificationSettings = {
  emailUpdates: boolean;
  productNews: boolean;
};

type NormalizedProfile = {
  firstName: string;
  lastName: string;
  profilePic: string;
  email: string;
};

function normalizeProfileValues(profile: UserProfile | null): NormalizedProfile | null {
  if (!profile) return null;
  return {
    firstName: (profile.firstName ?? "").trim(),
    lastName: (profile.lastName ?? "").trim(),
    profilePic: (profile.profilePic ?? "").trim(),
    email: (profile.email ?? "").trim(),
  };
}

export default function SettingsPage() {
  const { data: session } = useSession();
  const firstName = session?.user?.name?.split(" ")[0] || "there";

  const [profile, setProfile] = useState<UserProfile | null>(null);
  const [privacy, setPrivacy] = useState<PrivacySettings>({ showProfile: true, searchable: true });
  const [notifications, setNotifications] = useState<NotificationSettings>({ emailUpdates: true, productNews: false });
  const [loading, setLoading] = useState(true);
  const [initialProfile, setInitialProfile] = useState<NormalizedProfile | null>(null);
  const [initialPrivacy, setInitialPrivacy] = useState<PrivacySettings | null>(null);
  const [initialNotifications, setInitialNotifications] = useState<NotificationSettings | null>(null);

  // Section-specific states
  const [profileSaving, setProfileSaving] = useState(false);
  const [profileSuccess, setProfileSuccess] = useState<string | null>(null);
  const [profileError, setProfileError] = useState<string | null>(null);

  const [privacySaving, setPrivacySaving] = useState(false);
  const [privacySuccess, setPrivacySuccess] = useState<string | null>(null);
  const [privacyError, setPrivacyError] = useState<string | null>(null);

  const [notifSaving, setNotifSaving] = useState(false);
  const [notifSuccess, setNotifSuccess] = useState<string | null>(null);
  const [notifError, setNotifError] = useState<string | null>(null);

  // Password change
  const [showPassword, setShowPassword] = useState(false);
  const [currentPassword, setCurrentPassword] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [pwSaving, setPwSaving] = useState(false);
  const [pwError, setPwError] = useState<string | null>(null);
  const [pwSuccess, setPwSuccess] = useState<string | null>(null);

  const [activeModal, setActiveModal] = useState<"profile" | "privacy" | "password" | null>(null);
  const [confirming, setConfirming] = useState(false);

  // Load user settings
  useEffect(() => {
    setLoading(true);
    (async () => {
      try {
        const res = await fetch("/api/user/settings", { cache: "no-store" });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          const message = err?.error || "Failed to load settings";
          setProfileError(message);
          toast.error(message);
          return;
        }

        const data = await res.json();
        const fetchedProfile: UserProfile = {
          firstName: data.profile?.firstName ?? "",
          lastName: data.profile?.lastName ?? "",
          email: data.profile?.email ?? "",
          profilePic: data.profile?.profilePic ?? "",
        };
        const fetchedPrivacy: PrivacySettings = {
          showProfile: data.privacy?.showProfile ?? true,
          searchable: data.privacy?.searchable ?? true,
        };
        const fetchedNotifications: NotificationSettings = {
          emailUpdates: data.notifications?.emailUpdates ?? true,
          productNews: data.notifications?.productNews ?? false,
        };

        setProfile(fetchedProfile);
        setPrivacy({ ...fetchedPrivacy });
        setNotifications({ ...fetchedNotifications });
        setInitialProfile(normalizeProfileValues(fetchedProfile));
        setInitialPrivacy({ ...fetchedPrivacy });
        setInitialNotifications({ ...fetchedNotifications });
      } catch {
        setProfileError("Failed to load settings");
        toast.error("Failed to load settings");
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // Clear feedback after 3 seconds
  useEffect(() => {
    if (profileSuccess || profileError) {
      const t = setTimeout(() => {
        setProfileSuccess(null);
        setProfileError(null);
      }, 3000);
      return () => clearTimeout(t);
    }
  }, [profileSuccess, profileError]);

  useEffect(() => {
    if (privacySuccess || privacyError) {
      const t = setTimeout(() => {
        setPrivacySuccess(null);
        setPrivacyError(null);
      }, 3000);
      return () => clearTimeout(t);
    }
  }, [privacySuccess, privacyError]);

  useEffect(() => {
    if (notifSuccess || notifError) {
      const t = setTimeout(() => {
        setNotifSuccess(null);
        setNotifError(null);
      }, 3000);
      return () => clearTimeout(t);
    }
  }, [notifSuccess, notifError]);

  useEffect(() => {
    if (pwSuccess || pwError) {
      const t = setTimeout(() => {
        setPwSuccess(null);
        setPwError(null);
      }, 3000);
      return () => clearTimeout(t);
    }
  }, [pwSuccess, pwError]);

  // Profile update handler
  async function handleProfileUpdate() {
    if (!profile) return;
    const normalized = normalizeProfileValues(profile);
    if (!normalized) return;
    if (!normalized.firstName || !normalized.lastName) {
      setProfileError("First and last name are required.");
      return;
    }

    setProfileSaving(true);
    setProfileSuccess(null);
    setProfileError(null);
    try {
      const payload: Record<string, unknown> = {
        firstName: normalized.firstName,
        lastName: normalized.lastName,
      };
      if (normalized.profilePic.length > 0) {
        payload.profilePic = normalized.profilePic;
      }

      const res = await fetch("/api/user/settings", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ profile: payload }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err?.error || "Failed to update profile");
      }
      setProfile((prev) =>
        prev
          ? {
              ...prev,
              firstName: normalized.firstName,
              lastName: normalized.lastName,
              profilePic: normalized.profilePic,
            }
          : prev
      );
      setInitialProfile(normalized);
      setProfileSuccess("Profile updated!");
      toast.success("Profile updated!");
    } catch (err: any) {
      const message = err?.message || "Could not update profile.";
      setProfileError(message);
      toast.error(message);
    } finally {
      setProfileSaving(false);
    }
  }

  // Privacy update handler
  async function handlePrivacyUpdate() {
    setPrivacySaving(true);
    setPrivacySuccess(null);
    setPrivacyError(null);
    try {
      const res = await fetch("/api/user/settings", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ privacy }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err?.error || "Failed to update privacy");
      }
      setInitialPrivacy({ ...privacy });
      setPrivacySuccess("Privacy settings updated!");
      toast.success("Privacy settings updated!");
    } catch (err: any) {
      const message = err?.message || "Could not update privacy settings.";
      setPrivacyError(message);
      toast.error(message);
    } finally {
      setPrivacySaving(false);
    }
  }

  // Notification update handler
  async function handleNotificationsUpdate() {
    setNotifSaving(true);
    setNotifSuccess(null);
    setNotifError(null);
    try {
      const res = await fetch("/api/user/settings", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notifications }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err?.error || "Failed to update notifications");
      }
      setInitialNotifications({ ...notifications });
      setNotifSuccess("Notification preferences updated!");
      toast.success("Notification preferences updated!");
    } catch (err: any) {
      const message = err?.message || "Could not update notification preferences.";
      setNotifError(message);
      toast.error(message);
    } finally {
      setNotifSaving(false);
    }
  }

  // Password change handler
  async function handlePasswordChange() {
    setPwError(null);
    setPwSuccess(null);
    setPwSaving(true);
    if (!currentPassword || !newPassword || !confirmPassword) {
      setPwError("All fields are required.");
      toast.error("All fields are required.");
      setPwSaving(false);
      return;
    }
    if (newPassword.length < 8) {
      setPwError("New password must be at least 8 characters.");
      toast.error("New password must be at least 8 characters.");
      setPwSaving(false);
      return;
    }
    if (newPassword !== confirmPassword) {
      setPwError("Passwords do not match.");
      toast.error("Passwords do not match.");
      setPwSaving(false);
      return;
    }

    try {
      const res = await fetch("/api/user/settings/password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ currentPassword, newPassword }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err?.error || "Failed to change password");
      }
      setPwSuccess("Password changed successfully!");
      toast.success("Password changed successfully!");
      setCurrentPassword("");
      setNewPassword("");
      setConfirmPassword("");
    } catch (err: any) {
      const message = err?.message || "Could not change password.";
      setPwError(message);
      toast.error(message);
    } finally {
      setPwSaving(false);
    }
  }

  async function handleConfirm() {
    if (!activeModal) return;
    try {
      setConfirming(true);
      if (activeModal === "profile") {
        if (!profileValid || !profileDirty) {
          setActiveModal(null);
          return;
        }
        await handleProfileUpdate();
      } else if (activeModal === "privacy") {
        if (!privacyDirty) {
          setActiveModal(null);
          return;
        }
        await handlePrivacyUpdate();
      } else if (activeModal === "password") {
        if (!passwordReady) {
          setActiveModal(null);
          return;
        }
        await handlePasswordChange();
      }
      setActiveModal(null);
    } finally {
      setConfirming(false);
    }
  }

  const normalizedProfile = normalizeProfileValues(profile);
  const profileValid = !!(
    normalizedProfile &&
    normalizedProfile.firstName.length > 0 &&
    normalizedProfile.lastName.length > 0
  );
  const profileDirty = !!(
    normalizedProfile &&
    initialProfile &&
    (
      normalizedProfile.firstName !== initialProfile.firstName ||
      normalizedProfile.lastName !== initialProfile.lastName ||
      normalizedProfile.profilePic !== initialProfile.profilePic
    )
  );
  const privacyDirty = !!(
    initialPrivacy &&
    (privacy.showProfile !== initialPrivacy.showProfile || privacy.searchable !== initialPrivacy.searchable)
  );
  const notificationsDirty = !!(
    initialNotifications &&
    (notifications.emailUpdates !== initialNotifications.emailUpdates ||
      notifications.productNews !== initialNotifications.productNews)
  );
  const passwordReady =
    currentPassword.length > 0 &&
    newPassword.length >= 8 &&
    confirmPassword.length >= 8 &&
    newPassword === confirmPassword;

  let content: ReactNode;

  if (loading) {
    content = (
      <div className="max-w-3xl mx-auto flex items-center justify-center min-h-[320px]">
        <div className="flex flex-col items-center gap-3">
          <div className="h-10 w-10 rounded-full border-4 border-emerald-200 border-t-emerald-600 animate-spin" />
          <p className="text-sm text-neutral-500 font-medium">Loading your settings...</p>
        </div>
      </div>
    );
  } else if (!profile) {
    content = (
      <div className="max-w-3xl mx-auto">
        <div className="bg-rose-50 border border-rose-200 rounded-2xl px-6 py-8 text-center shadow-sm">
          <p className="text-rose-700 font-semibold mb-2">Unable to load your profile.</p>
          <p className="text-rose-500 text-sm">Please try again later.</p>
        </div>
      </div>
    );
  } else {
    content = (
      <div className="max-w-3xl mx-auto space-y-8">
        {/* Profile Section */}
        <form
          onSubmit={(e) => {
            e.preventDefault();
            if (!profileDirty || !profileValid) return;
            setActiveModal("profile");
          }}
          className="bg-white/95 backdrop-blur rounded-2xl shadow-md hover:shadow-lg p-6 sm:p-7 space-y-5 border border-neutral-100 transition-shadow duration-200"
        >
          <div className="flex items-start justify-between">
            <div>
              <h2 className="text-lg font-bold mb-1 flex items-center gap-2 text-neutral-900">
                <span className="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-emerald-50 to-emerald-100 text-emerald-700 shadow-sm">
                  <HiOutlineUser className="w-5 h-5" />
                </span>
                Profile Information
              </h2>
              <p className="text-xs text-neutral-500 mb-2">Update the basic details that help personalize your FoodFindr experience.</p>
            </div>
            {profileDirty && (
              <button
                type="button"
                onClick={() => {
                  if (!initialProfile) return;
                  setProfile({
                    firstName: initialProfile.firstName,
                    lastName: initialProfile.lastName,
                    email: initialProfile.email,
                    profilePic: initialProfile.profilePic,
                  });
                  toast.info("Changes discarded");
                }}
                className="flex items-center gap-1 text-xs text-neutral-500 hover:text-rose-600 transition px-2 py-1 rounded hover:bg-rose-50"
                title="Discard changes"
              >
                <HiOutlineXMark className="w-3.5 h-3.5" />
                Discard
              </button>
            )}
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold mb-1 text-neutral-800">First Name</label>
              <input
                type="text"
                className="w-full border border-neutral-200 rounded-lg px-3 py-2 text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300"
                value={profile.firstName || ""}
                onChange={(e) => setProfile({ ...profile, firstName: e.target.value })}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1 text-neutral-800">Last Name</label>
              <input
                type="text"
                className="w-full border border-neutral-200 rounded-lg px-3 py-2 text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300"
                value={profile.lastName || ""}
                onChange={(e) => setProfile({ ...profile, lastName: e.target.value })}
                required
              />
            </div>
          </div>
          <div>
            <label className="block text-sm font-semibold mb-1 text-neutral-800">Email</label>
            <input
              type="email"
              className="w-full border border-neutral-200 rounded-lg px-3 py-2 text-sm bg-neutral-100 text-neutral-500 cursor-not-allowed focus:outline-none"
              value={profile.email}
              disabled
            />
          </div>
          <div className="flex items-center gap-3 pt-2">
            <button
              type="submit"
              className="inline-flex items-center justify-center bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-sm py-2.5 px-6 rounded-lg shadow-sm hover:shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-emerald-600"
              disabled={profileSaving || !profileDirty || !profileValid}
            >
              {profileSaving ? (
                <>
                  <div className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2" />
                  Saving...
                </>
              ) : (
                "Save Changes"
              )}
            </button>
            {!profileDirty && !profileSaving && (
              <span className="flex items-center gap-1 text-xs text-neutral-400">
                <HiOutlineInformationCircle className="w-3.5 h-3.5" />
                No changes to save
              </span>
            )}
          </div>
          {profileSuccess && (
            <div className="mt-2 text-emerald-600 flex items-center gap-1 text-sm">
              <HiOutlineCheckCircle /> {profileSuccess}
            </div>
          )}
          {profileError && (
            <div className="mt-2 text-rose-600 flex items-center gap-1 text-sm">
              <HiOutlineExclamationCircle /> {profileError}
            </div>
          )}
        </form>

        {/* Privacy Section */}
        <div className="bg-white/95 backdrop-blur rounded-2xl shadow-md hover:shadow-lg p-6 sm:p-7 space-y-5 border border-neutral-100 transition-shadow duration-200">
          <div className="flex items-start justify-between">
            <div>
              <h2 className="text-lg font-bold mb-1 flex items-center gap-2 text-neutral-900">
                <span className="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 text-blue-700 shadow-sm">
                  <HiOutlineShieldCheck className="w-5 h-5" />
                </span>
                Privacy Settings
              </h2>
              <p className="text-xs text-neutral-500 mb-2">Control how your profile appears to others across FoodFindr.</p>
            </div>
            {privacyDirty && (
              <button
                type="button"
                onClick={() => {
                  if (!initialPrivacy) return;
                  setPrivacy({ ...initialPrivacy });
                  toast.info("Changes discarded");
                }}
                className="flex items-center gap-1 text-xs text-neutral-500 hover:text-rose-600 transition px-2 py-1 rounded hover:bg-rose-50"
                title="Discard changes"
              >
                <HiOutlineXMark className="w-3.5 h-3.5" />
                Discard
              </button>
            )}
          </div>
          <div className="flex flex-col gap-3">
            <label className="flex items-start gap-3 text-sm text-neutral-800">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 rounded border-neutral-300 text-emerald-600 focus:ring-emerald-200"
                checked={privacy.showProfile}
                onChange={(e) => setPrivacy({ ...privacy, showProfile: e.target.checked })}
              />
              <span>
                <span className="font-semibold block">Show my profile to others</span>
                <span className="text-xs text-neutral-500">Allow other users to see your name when interacting with shared content.</span>
              </span>
            </label>
            <label className="flex items-start gap-3 text-sm text-neutral-800">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 rounded border-neutral-300 text-emerald-600 focus:ring-emerald-200"
                checked={privacy.searchable}
                onChange={(e) => setPrivacy({ ...privacy, searchable: e.target.checked })}
              />
              <span>
                <span className="font-semibold block">Allow my profile to be searchable</span>
                <span className="text-xs text-neutral-500">Let others find you by name when collaboration features are available.</span>
              </span>
            </label>
          </div>
          <div className="flex items-center gap-3 pt-2">
            <button
              type="button"
              onClick={() => {
                if (!privacyDirty) return;
                setActiveModal("privacy");
              }}
              className="inline-flex items-center justify-center bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-sm py-2.5 px-6 rounded-lg shadow-sm hover:shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-emerald-600"
              disabled={privacySaving || !privacyDirty}
            >
              {privacySaving ? (
                <>
                  <div className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2" />
                  Saving...
                </>
              ) : (
                "Save Privacy"
              )}
            </button>
            {!privacyDirty && !privacySaving && (
              <span className="flex items-center gap-1 text-xs text-neutral-400">
                <HiOutlineInformationCircle className="w-3.5 h-3.5" />
                No changes to save
              </span>
            )}
          </div>
          {privacySuccess && (
            <div className="mt-2 text-emerald-600 flex items-center gap-1 text-sm">
              <HiOutlineCheckCircle /> {privacySuccess}
            </div>
          )}
          {privacyError && (
            <div className="mt-2 text-rose-600 flex items-center gap-1 text-sm">
              <HiOutlineExclamationCircle /> {privacyError}
            </div>
          )}
        </div>

        {/* Notification Section */}
        <div className="bg-white/95 backdrop-blur rounded-2xl shadow-md hover:shadow-lg p-6 sm:p-7 space-y-5 border border-neutral-100 transition-shadow duration-200">
          <div className="flex items-start justify-between">
            <div>
              <h2 className="text-lg font-bold mb-1 flex items-center gap-2 text-neutral-900">
                <span className="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-amber-50 to-amber-100 text-amber-700 shadow-sm">
                  <HiOutlineBell className="w-5 h-5" />
                </span>
                Notification Preferences
              </h2>
              <p className="text-xs text-neutral-500 mb-2">Choose when FoodFindr should keep you in the loop.</p>
            </div>
            {notificationsDirty && (
              <button
                type="button"
                onClick={() => {
                  if (!initialNotifications) return;
                  setNotifications({ ...initialNotifications });
                  toast.info("Changes discarded");
                }}
                className="flex items-center gap-1 text-xs text-neutral-500 hover:text-rose-600 transition px-2 py-1 rounded hover:bg-rose-50"
                title="Discard changes"
              >
                <HiOutlineXMark className="w-3.5 h-3.5" />
                Discard
              </button>
            )}
          </div>
          <div className="flex flex-col gap-3">
            <label className="flex items-start gap-3 text-sm text-neutral-800">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 rounded border-neutral-300 text-emerald-600 focus:ring-emerald-200"
                checked={notifications.emailUpdates}
                onChange={(e) => setNotifications({ ...notifications, emailUpdates: e.target.checked })}
              />
              <span>
                <span className="font-semibold block">Email me about important updates</span>
                <span className="text-xs text-neutral-500">Receive essential account and security-related emails.</span>
              </span>
            </label>
            <label className="flex items-start gap-3 text-sm text-neutral-800">
              <input
                type="checkbox"
                className="mt-1 h-4 w-4 rounded border-neutral-300 text-emerald-600 focus:ring-emerald-200"
                checked={notifications.productNews}
                onChange={(e) => setNotifications({ ...notifications, productNews: e.target.checked })}
              />
              <span>
                <span className="font-semibold block">Send me product news and offers</span>
                <span className="text-xs text-neutral-500">Get tips, inspiration, and FoodFindr news occasionally.</span>
              </span>
            </label>
          </div>
          <div className="flex items-center gap-3 pt-2">
            <button
              type="button"
              onClick={handleNotificationsUpdate}
              className="inline-flex items-center justify-center bg-emerald-600 hover:bg-emerald-700 text-white font-semibold text-sm py-2.5 px-6 rounded-lg shadow-sm hover:shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-emerald-600"
              disabled={notifSaving || !notificationsDirty}
            >
              {notifSaving ? (
                <>
                  <div className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2" />
                  Saving...
                </>
              ) : (
                "Save Notifications"
              )}
            </button>
            {!notificationsDirty && !notifSaving && (
              <span className="flex items-center gap-1 text-xs text-neutral-400">
                <HiOutlineInformationCircle className="w-3.5 h-3.5" />
                No changes to save
              </span>
            )}
          </div>
          {notifSuccess && (
            <div className="mt-2 text-emerald-600 flex items-center gap-1 text-sm">
              <HiOutlineCheckCircle /> {notifSuccess}
            </div>
          )}
          {notifError && (
            <div className="mt-2 text-rose-600 flex items-center gap-1 text-sm">
              <HiOutlineExclamationCircle /> {notifError}
            </div>
          )}
        </div>

        {/* Password Section */}
        <form
          onSubmit={(e) => {
            e.preventDefault();
            if (!passwordReady) return;
            setActiveModal("password");
          }}
          className="bg-white/95 backdrop-blur rounded-2xl shadow-md hover:shadow-lg p-6 sm:p-7 space-y-5 border border-neutral-100 transition-shadow duration-200"
        >
          <div className="flex items-start justify-between">
            <div>
              <h2 className="text-lg font-bold mb-1 flex items-center gap-2 text-neutral-900">
                <span className="flex h-9 w-9 items-center justify-center rounded-xl bg-gradient-to-br from-rose-50 to-rose-100 text-rose-700 shadow-sm">
                  <HiOutlineLockClosed className="w-5 h-5" />
                </span>
                Change Password
              </h2>
              <p className="text-xs text-neutral-500 mb-2">Keep your account secure by using a strong, unique password.</p>
            </div>
            {(currentPassword || newPassword || confirmPassword) && (
              <button
                type="button"
                onClick={() => {
                  setCurrentPassword("");
                  setNewPassword("");
                  setConfirmPassword("");
                  setPwError(null);
                  toast.info("Password fields cleared");
                }}
                className="flex items-center gap-1 text-xs text-neutral-500 hover:text-rose-600 transition px-2 py-1 rounded hover:bg-rose-50"
                title="Clear fields"
              >
                <HiOutlineXMark className="w-3.5 h-3.5" />
                Clear
              </button>
            )}
          </div>
          <div className="flex flex-col gap-4">
            <div>
              <label className="block text-sm font-semibold mb-1 text-neutral-800">Current Password</label>
              <input
                type={showPassword ? "text" : "password"}
                autoComplete="current-password"
                className="w-full border border-neutral-200 rounded-lg px-3 py-2 text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300"
                value={currentPassword}
                onChange={(e) => setCurrentPassword(e.target.value)}
                required
                disabled={pwSaving}
              />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1 text-neutral-800">New Password</label>
              <input
                type={showPassword ? "text" : "password"}
                autoComplete="new-password"
                className="w-full border border-neutral-200 rounded-lg px-3 py-2 text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                required
                minLength={8}
                disabled={pwSaving}
              />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-1 text-neutral-800">Confirm New Password</label>
              <input
                type={showPassword ? "text" : "password"}
                className="w-full border border-neutral-200 rounded-lg px-3 py-2 text-sm text-neutral-900 focus:outline-none focus:ring-2 focus:ring-emerald-200 focus:border-emerald-300"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                required
                minLength={8}
                disabled={pwSaving}
              />
            </div>
            <button
              type="button"
              className="flex items-center gap-2 text-xs text-emerald-600 hover:text-emerald-800"
              onClick={() => setShowPassword((v) => !v)}
              disabled={pwSaving}
            >
              {showPassword ? <HiOutlineEyeSlash /> : <HiOutlineEye />}
              {showPassword ? "Hide Passwords" : "Show Passwords"}
            </button>
          </div>
          <div className="flex items-center gap-3 pt-2">
            <button
              type="submit"
              className="inline-flex items-center justify-center bg-rose-600 hover:bg-rose-700 text-white font-semibold text-sm py-2.5 px-6 rounded-lg shadow-sm hover:shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-rose-600"
              disabled={pwSaving || !passwordReady}
            >
              {pwSaving ? (
                <>
                  <div className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2" />
                  Changing...
                </>
              ) : (
                "Change Password"
              )}
            </button>
            {!passwordReady && !pwSaving && (
              <span className="flex items-center gap-1 text-xs text-neutral-400">
                <HiOutlineInformationCircle className="w-3.5 h-3.5" />
                {!currentPassword && !newPassword ? "Fill in all fields" : "Passwords must match (8+ chars)"}
              </span>
            )}
          </div>
          {pwSuccess && (
            <div className="mt-2 text-emerald-600 flex items-center gap-1 text-sm">
              <HiOutlineCheckCircle /> {pwSuccess}
            </div>
          )}
          {pwError && (
            <div className="mt-2 text-rose-600 flex items-center gap-1 text-sm">
              <HiOutlineExclamationCircle /> {pwError}
            </div>
          )}
        </form>
      </div>
    );
  }

  return (
    <div className="flex h-screen overflow-hidden relative bg-white">
      {/* Background image with subtle overlay (mirrors dashboard) */}
      <div
        className="absolute inset-0 z-0 pointer-events-none"
        aria-hidden="true"
        style={{
          backgroundImage:
            "url('https://images.unsplash.com/photo-1514996937319-344454492b37?w=1600&q=80&auto=format&fit=crop')",
          backgroundSize: "cover",
          backgroundPosition: "center",
          opacity: 0.08,
        }}
      />

      {/* Sidebar */}
      <Sidebar />

      {/* Main Content */}
      <main className="flex-1 h-full overflow-y-auto relative z-10">
        <div className="h-full w-full px-4 sm:px-8 py-8 sm:py-12">
          {/* Header */}
          <div className="mb-10 sm:mb-12">
            <div className="flex items-center gap-4 mb-3">
              <div className="flex items-center justify-center h-12 w-12 sm:h-14 sm:w-14 rounded-3xl bg-gradient-to-br from-emerald-100 to-emerald-200 shadow-lg">
                <HiOutlineUser className="h-6 w-6 sm:h-7 sm:w-7 text-emerald-700" />
              </div>
              <div>
                <h1 className="text-3xl sm:text-4xl font-extrabold text-neutral-900 tracking-tight mb-1">
                  Account Settings
                </h1>
                <p className="text-neutral-600 text-sm sm:text-base">
                  Fine-tune your profile, security, and preferences{session?.user?.name ? `, ${firstName}` : ""}.
                </p>
              </div>
            </div>
          </div>

          {content}
        </div>
      </main>
      {activeModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm px-4 animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-in zoom-in-95 duration-200">
            <h3 className="text-lg font-bold text-neutral-900 mb-2">
              {activeModal === "profile" && "Update Profile"}
              {activeModal === "privacy" && "Update Privacy Settings"}
              {activeModal === "password" && "Change Password"}
            </h3>
            <p className="text-sm text-neutral-600 mb-6">
              {activeModal === "profile" && "Are you sure you want to update your public profile details?"}
              {activeModal === "privacy" && "Are you sure you want to change your visibility settings?"}
              {activeModal === "password" &&
                "Are you sure you want to change your password? You will need to log in again on other devices."}
            </p>
            <div className="flex justify-end gap-3">
              <button
                type="button"
                className="px-4 py-2 rounded-lg border-2 border-neutral-200 text-sm font-semibold text-neutral-700 hover:bg-neutral-50 hover:border-neutral-300 transition-all"
                onClick={() => setActiveModal(null)}
                disabled={confirming}
              >
                Cancel
              </button>
              <button
                type="button"
                className="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700 shadow-md hover:shadow-lg transition-all disabled:opacity-60 disabled:cursor-not-allowed"
                onClick={handleConfirm}
                disabled={confirming}
              >
                {confirming ? (
                  <span className="flex items-center gap-2">
                    <div className="h-4 w-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                    Confirming...
                  </span>
                ) : (
                  "Confirm"
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}